<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.infohub.project.boardCommentMapper">

	<!-- 게시글 아래 댓글 전체보기 -->
	<select id="getCommentsByboardno" resultMap="commentResultMap">
		SELECT
        c.commentId,
        c.comment,
        c.createdDate,
        c.parentCommentId,
        c.boardno,
        c.loginNo,
        l.name AS loginUser
    FROM commentboard c
    JOIN login l ON c.loginNo = l.loginNo
    WHERE c.boardno = #{boardno}
    AND c.parentCommentId IS NULL  -- 또는 AND (c.parentCommentId IS NULL OR c.parentCommentId = 0)
    ORDER BY c.commentId ASC
	</select>

	<!-- 댓글/대댓글 작성 -->
	<insert id="insertComment" useGeneratedKeys="true"
		keyProperty="commentId">
		INSERT INTO commentboard (boardno, loginNo, loginUser, parentCommentId,
		comment, createdDate)
		VALUES (#{boardno}, #{loginNo}, #{loginUser}, #{parentCommentId},
		#{comment}, NOW())
	</insert>


	<!-- 대댓글 조회 -->
	<select id="getRepliesByCommentId" resultMap="commentResultMap">
		 SELECT
        c.commentId,
        c.comment,
        c.createdDate,
        c.lastModified,
        c.parentCommentId,
        c.boardno,
        c.loginNo,
        l.name AS loginUser  FROM commentboard c
    JOIN login l ON c.loginNo = l.loginNo
    WHERE c.parentCommentId = #{commentId}
    ORDER BY c.createdDate ASC
	</select>

	<!-- 댓글 선택 -->
	<select id="getCommentById" parameterType="int"
		resultType="com.infohub.project.boardcomment.CommentBoardVO">
		 SELECT 
        c.commentId, 
        c.boardno, 
        c.loginNo, 
        l.name AS loginUser, c.parentCommentId, 
        c.comment,
        c.hearts, 
        c.createdDate, 
        c.lastModified
    FROM commentboard c
    JOIN login l ON c.loginNo = l.loginNo
    WHERE c.commentId = #{commentId}
	</select>

	<!-- 댓글 수정 -->
	<update id="updateComment"
		parameterType="com.infohub.project.boardcomment.CommentBoardVO">
		UPDATE commentboard
		SET comment = #{comment},
		lastModified = NOW()
		WHERE commentId = #{commentId} AND loginNo =
		#{loginNo}
	</update>

	<!-- 댓글 삭제 -->
	<delete id="deleteComment">
		DELETE FROM commentboard WHERE commentId =
		#{commentId} AND loginNo =
		#{loginNo}
	</delete>

	<!-- 해당 게시글의 댓글 전체 삭제 -->
	<delete id="deleteAll" parameterType="int">
		DELETE FROM commentboard
		WHERE boardno = #{boardno}
	</delete>

	<!-- ResultMap -->
	<resultMap id="commentResultMap"
		type="com.infohub.project.boardcomment.CommentBoardVO">
		<id property="commentId" column="commentId" />
		<result property="boardno" column="boardno" />
		<result property="loginNo" column="loginNo" />
		<result property="loginUser" column="loginUser" />
		<result property="parentCommentId" column="parentCommentId" />
		<result property="comment" column="comment" />
		<result property="hearts" column="hearts" />
		<result property="createdDate" column="createdDate" />
		<result property="lastModified" column="lastModified" />
		<collection property="replies" ofType="CommentBoardVO"
			select="getRepliesByCommentId" column="commentId" />
	</resultMap>

</mapper>